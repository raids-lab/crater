---
title: すばやく始める
description: Crater をデプロイして使用する
---

Crater プラットフォームは Kubernetes クラスターに依存して動作するため、デプロイする前に一連の基本的な依存コンポーネントを準備する必要があります。これらのコンポーネントは、モニタリング、ストレージ、ネットワーク、スケジューリング、イメージリポジトリなど、プラットフォームが正常に起動および動作するために必要なコア機能を提供します。

最小限のデプロイメント方案では、できるだけコアで不可欠な依存のみを残し、複雑さを過剰に導入することを避けています。最終的に選定された依存は以下の通りです：

- **NVIDIA GPU Operator**：GPUドライバ、デバイスプラグイン、モニタリングコンポーネントをインストールし、CraterがGPUタスクをスケジュールできるようにします。
- **Bitnami PostgreSQL**：高可用性を考慮しないPostgreSQLデータベースサービスで、本方案ではCraterの外部データベースとして使用されます。
- **IngressClass (Ingress-Nginx)**：外部トラフィックのルーティングを処理し、ユーザーのリクエストをクラスター内のサービスに転送します。
- **Volcano**：バッチ処理とAIワークロード向けのスケジューリングフレームワークで、Craterのジョブスケジューリングのコアです。
- **StorageClass (NFS)**：データベースとHarborに永続ストレージ能力を提供する統一された分散ストレージバックエンド。

これらのコンポーネントを選択した理由は、**Crater プラットフォームの最小動作環境**に必要なキーポイントであり、それらがなければプラットフォームは正常に動作しません。**Prometheus/Grafana モニタリングスタック**、**MetalLB ロードバランサー**、**OpenEBS ストレージ**などの強力だが必須ではない依存は、最小バージョンから除外され、デプロイのハードルを下げています。

## インストール

### GitHub Container Registry からインストール (推奨)

```bash
# Helm OCI レポジトリを追加
helm registry login ghcr.io

# チャートをインストール
helm install crater oci://ghcr.io/raids-lab/crater --version 0.1.0

# 既存のインストールをアップグレード
helm upgrade crater oci://ghcr.io/raids-lab/crater --version 0.1.0
```

### ソースからインストール

```bash
# レポジトリをクローン
git clone https://github.com/raids-lab/crater.git
cd crater/charts

# チャートをインストール
helm install crater crater/
```

## 設定

チャートは値ファイルを使用して設定できます。`values.yaml` ファイルを作成し、特定の設定を記入してください：

```yaml
# 例: 最小限の設定
backendConfig:
  postgres:
    host: "your-postgres-host"
    password: "your-password"
  auth:
    accessTokenSecret: "your-access-token-secret"
    refreshTokenSecret: "your-refresh-token-secret"
```

次に、あなたの値を使用してインストールします：

```bash
helm install crater oci://ghcr.io/raids-lab/crater --values values.yaml
```

詳細な設定の意味については、[設定説明](../chart)を参照してください。

## 事前依存のデプロイ

| コンポーネント           | 目的                          |
| ------------------- | -------------------------------- |
| NVIDIA GPU Operator | GPUデバイスプラグインとモニタリング |
| Bitnami PostgreSQL  | PostgreSQLデータベースサービス       |
| IngressClass        | Ingressトラフィックルーティング         |
| Volcano             | ベースジョブスケジューリングフレームワーク    |
| StorageClass (NFS)  | 分散ストレージバックエンド            |

### IngressClass

本番クラスターでは、ロードバランサー（例: MetalLB）と Ingress コントローラーを併用するのが一般的です。しかし、最小デプロイメントのケースでは、クラスター内のサービスに外部リクエストをルーティングするための **Ingress-Nginx コントローラー** のみが必要です。これにより、ネットワークプラグインやロードバランサー機能への追加の依存を避けることができます。

Helmを使用して Ingress-Nginx コントローラーを直接デプロイできます：

```
# 公式リポジトリを追加
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update

# ingress-nginx をデプロイ
helm install ingress-nginx ingress-nginx/ingress-nginx \
  -n ingress-nginx --create-namespace
```

### Volcano

Craterのタスクの実行とスケジューリングは、Volcanoが提供するバッチ計算スケジューリング機能に依存しています。VolcanoはAI/ビッグデータのシナリオに最適化されており、キュー、優先度、Gangスケジューリングなどの機能をサポートしています。最小限のデプロイメント環境においても、Volcanoは不可欠なコアコンポーネントであり、これをなしにするとCraterはタスクのスケジューリングや実行ができません。

### デプロイコマンド

```
# Volcano レポジトリを追加
helm repo add volcano-sh https://volcano-sh.github.io/helm-charts
helm repo update

# デプロイ
helm upgrade --install volcano volcano-sh/volcano \
  --namespace volcano-system \
  --create-namespace \
  --version 1.10.0 \
  -f volcano/values.yaml
```

value.yaml 設定例: https://github.com/raids-lab/crater-backend/blob/main/deployments/volcano/values.yaml

#### デプロイの確認

```
kubectl get pods -n volcano-system
```

正常に実行されているコンポーネント:

- `volcano-scheduler`

- `volcano-controllers`

- `volcano-admission`

- `volcano-webhook`


### StorageClass (NFS)

NFSは分散ストレージバックエンドを提供し、HarborとCNPGのPVCはすべてこれに依存します。

1. NFSサーバーでディレクトリを作成し、権限を設定します：

   ```
   mkdir -p /srv/nfs/k8s
   chown -R 26:26 /srv/nfs/k8s
   ```

2. `/etc/exports` を編集し、エクスポートルールを追加します：

   ```
   /srv/nfs/k8s 192.168.103.0/24(rw,sync,no_subtree_check,no_root_squash)
   ```

3. エクスポートを再読み込みします：

   ```
   exportfs -rv
   ```

4. K8sクラスターに **nfs-subdir-external-provisioner** をデプロイします：

   ```
   helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/
   helm repo update
   helm install nfs-client nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
     --namespace nfs-provisioner --create-namespace \
     --set nfs.server=192.168.103.136 \
     --set nfs.path=/srv/nfs/k8s
   ```

5. StorageClassを確認します：

   ```
   kubectl get sc
   ```

   `nfs-client` が存在し、`provisioner` が `nfs-subdir-external-provisioner` であることを確認してください。

------


### CloudNativePG (CNPG)

Kubernetesのステートフルコンポーネント（例: データベース、イメージリポジトリ）は、永続ストレージのサポートが必要です。最小デプロイバージョンでは、**NFSを統一された分散ストレージバックエンドとして選択**しています。それは設定が簡単で、互換性が良く、OpenEBSやCephなどの複雑なストレージシステムを追加でデプロイする必要がないからです。
NFSから提供されるStorageClassを使用して、HarborとCNPGは直接PVCを要求し、永続ストレージを実現できます。この方法では、下層のストレージの詳細を気にすることなく、軽量かつリソースが限られた環境でも簡単に実装可能です。

CNPGはHarborの外部データベース管理コンポーネントです。

1. Operatorをデプロイします：

   ```
   helm repo add cnpg https://cloudnative-pg.github.io/charts
   helm repo update
   helm install cnpg cnpg/cloudnative-pg --namespace cnpg-system --create-namespace
   ```

2. データベースユーザーのパスワードSecretを作成します：

   ```
   kubectl -n cnpg-system create secret generic harbor-db-password \
     --from-literal=password='HarborDbPass!'
   ```

3. データベースクラスターを定義 (`harbor-pg.yaml`)：

   ```
   apiVersion: postgresql.cnpg.io/v1
   kind: Cluster
   metadata:
     name: harbor-pg
   spec:
     instances: 1
     imageName: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/ghcr.io/cloudnative-pg/postgresql:15
     storage:
       size: 5Gi
       storageClass: nfs-client
     bootstrap:
       initdb:
         database: registry
         owner: harbor
         secret:
           name: harbor-db-password
           key: password
   ```

   ```
   kubectl apply -f harbor-pg.yaml -n cnpg-system
   ```

4. CNPGを確認します：

   ```
   kubectl -n cnpg-system get pods
   kubectl -n cnpg-system get svc | grep harbor-pg
   ```

   あなたは以下を確認する必要があります：

   - `harbor-pg-1` Pod が Running している
   - `harbor-pg-rw` Service が 5432 ポートを提供している

5. データベースにログインしてテストします：

   ```
   kubectl -n cnpg-system exec -it harbor-pg-1 -c postgres -- \
     psql -h 127.0.0.1 -U harbor -d registry -W
   ```

------


### Harborのデプロイ

HarborはCraterプラットフォームに依存するイメージリポジトリです。内網やオフライン環境では、パブリックイメージリポジトリ（例: DockerHub、ghcr.io）がしばしばアクセス不能であるため、Craterのフロントエンドとバックエンド、および依存イメージを保存するためのプライベートリポジトリが必要になります。
Harborを選択した理由は、**イメージ管理、権限制御、セキュリティスキャン**などの企業向け機能を備え、Kubernetesとネイティブに統合されているからです。最小限のデプロイ環境では、Harborは**NFSストレージ**と**CNPG外部データベース**にのみ依存し、Redis/Postgresの組み込みバージョンを追加で依存しなくなり、全体アーキテクチャを簡素化します。
これにより、Craterのイメージをローカルで保存および配布でき、将来的な拡張（例: マルチユーザー、マルチプロジェクトのイメージ管理）に基礎を提供します。

Harborは上記の **NFS** ストレージと **CNPG 外部データベース** を使用します。

1. Chartをダウンロードします：

   ```
   helm repo add harbor https://helm.goharbor.io
   helm repo update
   helm pull harbor/harbor --untar --untardir ./charts
   cd charts/harbor
   ```

2. `values.yaml` を編集し、重要な変更を行います：

   - 暴露方法 (NodePort):

     ```
     expose:
       type: nodePort
       nodePort:
         ports:
           http:
             port: 30002
     externalURL: http://192.168.103.136:30002
     ```

   - 外部データベースの使用:

     ```
     database:
       type: external
       external:
         host: harbor-pg-rw.cnpg-system.svc
         port: "5432"
         username: harbor
         coreDatabase: registry
         existingSecret: harbor-db-password
     ```

   - PVCの指定:

     ```
     persistence:
       enabled: true
       resourcePolicy: "keep"
       persistentVolumeClaim:
         registry:
           existingClaim: harbor-registry
           storageClass: nfs-client
           size: 50Gi
     ```

   - ミラーリングソースの置き換え（以下の表に示すミラーリングソースが準備されている必要があります。華為雲ミラーリングソースを使用可能です）：

| コンポーネント                      | レポジトリ (repo)                      | タグ       | 置き換えイメージ                                                     |
| ------------------------- | ------------------------------- | --------- | ------------------------------------------------------------ |
| nginx                     | `goharbor/nginx-photon`         | `v2.12.0` | swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/goharbor/nginx-photon:v2.12.0 |
| portal                    | `goharbor/harbor-portal`        | `v2.12.0` | swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/goharbor/harbor-portal:v2.12.0 |
| core                      | `goharbor/harbor-core`          | `v2.12.0` | swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/goharbor/harbor-core:v2.12.0 |
| jobservice                | `goharbor/harbor-jobservice`    | `v2.12.0` | swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/goharbor/harbor-jobservice:v2.12.0 |
| registry（distribution）  | `goharbor/registry-photon`      | `v2.12.0` | swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/goharbor/registry-photon:v2.12.0 |
| registryctl               | `goharbor/harbor-registryctl`   | `v2.12.0` | swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/goharbor/harbor-registryctl:v2.12.0 |
| trivy-adapter             | `goharbor/trivy-adapter-photon` | `v2.12.0` | swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/goharbor/trivy-adapter-photon:v2.12.1 |
| database（組み込みPostgres） | `goharbor/harbor-db`            | `v2.12.0` | swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/goharbor/harbor-db:v2.12.0 |
| redis（組み込みRedis）       | `goharbor/redis-photon`         | `v2.12.0` | swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/goharbor/redis-photon:v2.12.0 |
| exporter                  | `goharbor/harbor-exporter`      | `v2.12.0` | swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/goharbor/harbor-exporter:v2.12.0 |

3. Harborをデプロイします：

   ```
   helm install harbor . -n harbor-system --create-namespace -f values.yaml
   ```

4. Podの状態を確認します：

   ```
   kubectl -n harbor-system get pods
   ```

   コンポーネントが正常に動作していることを確認してください：

   - `harbor-core` ✅
   - `harbor-jobservice` ✅
   - `harbor-portal`, `harbor-nginx`, `harbor-registry`, `harbor-redis`, `harbor-trivy` ✅

5. Harborにアクセスします：

   ブラウザでアクセスしてください

   ```
   http://192.168.103.136:30002
   ```

   デフォルトユーザー：`admin`
   デフォルトパスワード：`values.yaml` で設定された `harborAdminPassword`