# depolyment configuration variables
createNamespace: false
imagePullSecrets: []

global:
  host: "gpu.raids-lab.cn"                # Main service domain
  grafanaHost: "gpu-grafana.raids-lab.cn" # Grafana domain
  apiBase: "https://gpu.raids-lab.cn/api/" # API base URL
  websiteBase: "https://raids-lab.github.io/crater/cn" # Website base URL
  namespace: "crater-workspace"
  imageNamespace: "crater-images"
  tlsSecretName: "crater-tls-secret"
  tlsForwardSecretName: "crater-tls-forward-secret"
  secrets:
    dbPassword: "<TO_BE_SET_BY_USER>"           # PostgreSQL database password
    adminPassword: "<TO_BE_SET_BY_USER>"        # Admin account password
    grafanaToken: "<TO_BE_SET_BY_USER>"         # Grafana API token
    registryPass: "<TO_BE_SET_BY_USER>"         # Registry robot password
    registryAdminPass: "<TO_BE_SET_BY_USER>"    # Registry admin password
    chameleonKey: "<TO_BE_SET_BY_USER>"         # OpenAPI chameleon key
    openApiAccessToken: "<TO_BE_SET_BY_USER>"   # OpenAPI access token
    ldapPassword: "<TO_BE_SET_BY_USER>"         # LDAP authentication password
    accessTokenSecret: "<TO_BE_SET_BY_USER>"    # JWT access token secret
    refreshTokenSecret: "<TO_BE_SET_BY_USER>"   # JWT refresh token secret
    smtpPassword: "<TO_BE_SET_BY_USER>"         # SMTP email password
    cronjobPassword: "<TO_BE_SET_BY_USER>"      # CronJob account password
    cronjobUsername: "<TO_BE_SET_BY_USER>"      # CronJob account username
    tlsBaseCert: "<TO_BE_SET_BY_USER>"          # Base TLS certificate (base64)
    tlsBaseKey: "<TO_BE_SET_BY_USER>"           # Base TLS private key (base64)
    tlsForwardCert: "<TO_BE_SET_BY_USER>"       # Forward TLS certificate (base64)
    tlsForwardKey: "<TO_BE_SET_BY_USER>"        # Forward TLS private key (base64)
    dockerconfigjson: "<TO_BE_SET_BY_USER>"     # Docker registry authentication config (base64)
    ssConfigContent: "<TO_BE_SET_BY_USER>"      # Storage server sensitive config content

urls:
  host: {{ .Values.global.host }}
  grafanaHost: {{ .Values.global.grafanaHost }}

images:
  backend:
    repository: "ghcr.io/raids-lab/crater-backend"
    tag: "sha-1fc613a"
  frontend:
    repository: "ghcr.io/raids-lab/crater-frontend"
    tag: "sha-d43d765"
  storage:
    repository: "crater-harbor.raids-lab.cn/crater/webdav"
    tag: "pfl9s61a"
  cronjob:
    repository: "crater-harbor.raids-lab.cn/crater/curl-jq"
    tag: "v0"
  grafanaProxy:
    repository: "crater-harbor.raids-lab.cn/docker.io/library/nginx"
    tag: "1.27.3-bookworm"
  buildkit:
    repository: "crater-harbor.raids-lab.cn/docker.io/moby/buildkit"
    tag: "v0.23.1"

nodeSelector:
  node-role.kubernetes.io/control-plane: ""

tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

affinity:
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      preference:
        matchExpressions:
          - key: nvidia.com/gpu.present
            operator: NotIn
            values:
              - "true"

web:
  migrate:
    createMigrationJob: true
    admin:
      username: "crater-admin"
      password: {{ .Values.global.secrets.adminPassword | quote }}
  ingress:
    host: {{ .Values.global.host }}
  grafana:
    host: {{ .Values.global.grafanaHost }}
    address: http://prometheus-grafana.monitoring
    token: {{ .Values.global.secrets.grafanaToken | quote }}
    ancestor: https://gpu.raids-lab.cn

# BuildKit configuration variables
buildkitConfig:
  amdConfig:
    enabled: true
    replicas: 3
    cache:
      storageClass: "openebs-hostpath"
      storageSize: 400Gi
      maxUsedSpace: "400GB"
      minFreeSpace: "50GB"
      reservedSpace: "50GB"
  armConfig:
    enabled: false # Can only be true when ARM nodes exist.
    replicas: 2
    cache:
      storageClass: "openebs-hostpath"
      storageSize: 80Gi
      maxUsedSpace: "80GB"
      minFreeSpace: "10GB"
      reservedSpace: "10GB"
  generalConfig:
    dockerconfigjson: {{ .Values.global.secrets.dockerconfigjson | quote }}
    resources:
      requests:
        cpu: 8
        memory: 24Gi
      limits:
        cpu: 16
        memory: 48Gi

# Frontend configuration variables
frontendConfig:
  version: "1.0.0"
  url:
    host: {{ .Values.global.host }}
    apiBase: {{ .Values.global.apiBase }}
    apiVersion: "v1"
    websiteBase: {{ .Values.global.websiteBase }}
  grafana:
    overview:
      main: "https://gpu-grafana.raids-lab.cn/d/f33ade9f-821d-4e96-a7f2-eb16c8b9c447/838ffad"
      schedule: "https://gpu-grafana.raids-lab.cn/d/be9oh7yk24jy8f/crater-gpu-e8b083-e5baa6-e58f82-e88083"
      network: "https://gpu-grafana.raids-lab.cn/d/8b7a8b326d7a6f1f04y7fh66368c67af/networking"
    node:
      basic: "https://gpu-grafana.raids-lab.cn/d/k8s_views_nodes/crater-node-basic-dashboard"
      nvidia: "https://gpu-grafana.raids-lab.cn/d/nvidia-dcgm-dashboard/crater-node-nvidia-dashboard"
    job:
      basic: "https://gpu-grafana.raids-lab.cn/d/R4ZPFfyIz/crater-job-basic-dashboard"
      nvidia: "https://gpu-grafana.raids-lab.cn/d/2CDE0AC7/crater-job-nvidia-dashboard"
      pod: "https://gpu-grafana.raids-lab.cn/d/MhnFUFLSz/crater-pod-dashboard"
    user:
      nvidia: "https://gpu-grafana.raids-lab.cn/d/user-nvidia-dcgm-dashboard/crater-user-nvidia-dashboard"
  featureFlags:
    enableRegister: true

# Backend configuration variables
backendConfig:
  enableLeaderElection: false
  leaderElectionID: 1ca428e5.training-operator.kubeflow.org
  prometheusAPI: http://prometheus-kube-prometheus-prometheus.monitoring:9090
  serverAddr: :8088
  metricsAddr: :8080
  probeAddr: :8081
  monitoringPort: 9443
  host: {{ .Values.global.host }}
  tlsSecretName: crater-tls-secret
  tlsForwardSecretName: crater-tls-forward-secret
  postgres:
    host: database-cluster-rw.crater
    port: 5432
    dbname: crater
    user: crater
    password: {{ .Values.global.secrets.dbPassword | quote }}
    sslmode: disable
    TimeZone: Asia/Shanghai
  userSpacePrefix: sugon-gpu-home-lab
  accountSpacePrefix: crater-accounts
  publicSpacePrefix: sugon-gpu-incoming
  workspace:
    namespace: {{ .Values.global.namespace | default "crater-workspace" }}
    ingressName: crater-jobs-ingress
    imageNameSpace: {{ .Values.global.imageNamespace | default "crater-images" }}
  act:
    strictRegisterMode: true
    uidServerURL: <MASKED>
    image:
      registryServer: gpu-harbor.raids-lab.cn
      registryUser: robot$gpu-crater
      registryPass: {{ .Values.global.secrets.registryPass | quote }}
      registryProject: crater
      registryAdmin: admin
      registryAdminPass: {{ .Values.global.secrets.registryAdminPass | quote }}
    openAPI:
      url: <MASKED>
      chameleonKey: {{ .Values.global.secrets.chameleonKey | quote }}
      accessToken: {{ .Values.global.secrets.openApiAccessToken | quote }}
    auth:
      userName: <MASKED>
      password: {{ .Values.global.secrets.ldapPassword | quote }}
      address: <MASKED>
      searchDN: <MASKED>
      accessTokenSecret: {{ .Values.global.secrets.accessTokenSecret | quote }}
      refreshTokenSecret: {{ .Values.global.secrets.refreshTokenSecret | quote }}
    smtp:
      host: mail.raids-lab.cn
      port: 25
      user: notify
      password: {{ .Values.global.secrets.smtpPassword | quote }}
      notify: notify@raids-lab.cn
  schedulerPlugins:
    aijob:
      aijobEn: false
      enableProfiling: true
      profilingTimeout: 120
    spjob:
      spjobEn: false
      predictionServiceAddress: http://resource-analyze-svc.kube-gpu-sparse:80
  dindArgs:
    buildxImage: crater-harbor.raids-lab.cn/xxx/buildx-multiarch:v6
    nerdctlImage: crater-harbor.raids-lab.cn/crater/nerdctl:2.0.1-retry
    envdImage: gpu-harbor.raids-lab.cn/xxx/envd-build-frontend:v1.2.1

# CronJob Config
cronjobConfig:
  USERNAME: {{ .Values.global.secrets.cronjobUsername | quote }}
  PASSWORD: {{ .Values.global.secrets.cronjobPassword | quote }}
  HOST: {{ .Values.global.host }}
  jobs:
    lowGPUUtil:
      schedule: "*/5 * * * *"
      TIME_RANGE: "90"
      WAIT_TIME: "30"
      UTIL: "0"
    longTime:
      schedule: "*/5 * * * *"
      BATCH_DAYS: "4"
      INTERACTIVE_DAYS: "4"
    waitingJupyter:
      schedule: "*/5 * * * *"
      JUPYTER_WAIT_MINUTES: "5"

# cert-manager configuration variables
tls:
  base:
    enabled: false
    cert: {{ .Values.global.secrets.tlsBaseCert | quote }}
    key: {{ .Values.global.secrets.tlsBaseKey | quote }}
  forward:
    enabled: false
    cert: {{ .Values.global.secrets.tlsForwardCert | quote }}
    key: {{ .Values.global.secrets.tlsForwardKey | quote }}

ssConfig:
  content: {{ .Values.global.secrets.ssConfigContent | quote }}

# pvc configuration variables
storage:
  create: false
  request: 2Ti
  storageClass: "rook-ceph-rbd"
  rwName: "crater-rw-storage"
  roName: "crater-ro-storage"