# Copyright 2025 Crater
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: AutoCorrect Website Files

on:
  pull_request_target:
    paths:
      - '.github/**'
      - 'crater-website/src/**'
      - 'crater-website/content/**'

jobs:
  autocorrect:
    name: Run AutoCorrect on Website
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Get files to autocorrect (internal PRs)
        if: github.event.pull_request.head.repo.full_name == github.repository
        id: internal_files
        run: |
          # 列出所有潜在文件，然后使用 grep -v 排除掉 *.*.mdx
          # 注意：这里的 glob 模式要与 autocorrect 期望的一致
          FILES=$(find crater-website/src crater-website/messages crater-website/content -type f -print0 | xargs -0 grep -E -v '(\.[^/.]+){1}\.mdx$' | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: AutoCorrect and Fix (for internal PRs)
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: huacnlee/autocorrect-action@v2
        with:
          # 将过滤后的文件列表传递给 autocorrect
          args: --fix ${{ steps.internal_files.outputs.files }}

      - name: Commit changes (for internal PRs)
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style(website): Auto-correct files by autocorrect-action"
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: GitHub Actions <41898282+github-actions[bot]@users.noreply.github.com>

      # --- Forked PR ---
      - name: Get changed files in website dirs (for forked PRs)
        if: github.event.pull_request.head.repo.full_name != github.repository
        id: changed-files
        run: |
          # 获取变更的文件列表
          ALL_CHANGED_FILES=$(git diff --name-only -z --diff-filter=AM ${{ github.event.pull_request.base.sha }} -- 'crater-website/src/**' 'crater-website/content/**' 'crater-website/messages/**' | xargs -0)
          
          # 使用 grep -v 过滤掉 *.*.mdx 文件
          # 注意：为了让 grep 能够正确处理空格和换行，我们使用 find 和 grep。
          # 或者，更简单但可能内存占用稍高的方法是先将所有文件放入数组或临时文件。
          # 这里假设 $ALL_CHANGED_FILES 已经是以空格分隔的文件列表
          
          if [ -n "$ALL_CHANGED_FILES" ]; then
              # 将空格分隔的字符串转换为行分隔，然后用 grep 过滤
              FILTERED_FILES=$(echo "$ALL_CHANGED_FILES" | tr ' ' '\n' | grep -E -v '(\.[^/.]+){1}\.mdx$' | tr '\n' ' ')
              if [ -n "$FILTERED_FILES" ]; then
                  echo "files_exist=true" >> $GITHUB_OUTPUT
                  echo "files=$FILTERED_FILES" >> $GITHUB_OUTPUT
              else
                  echo "files_exist=false" >> $GITHUB_OUTPUT
              fi
          else
              echo "files_exist=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Create Lint and Report Script
        if: steps.changed-files.outputs.files_exist == 'true'
        run: |
          cat << 'EOF' > ./lint_and_report.sh
          #!/bin/sh
          set -e
          
          echo "--- Running AutoCorrect and piping to Reviewdog ---"
          autocorrect --lint --format rdjson ${{ steps.changed-files.outputs.files }} | reviewdog -f=rdjson -reporter=github-pr-review -level=warning
          EOF
          
          chmod +x ./lint_and_report.sh

      - name: Run Custom Script inside Action Container
        if: steps.changed-files.outputs.files_exist == 'true'
        uses: huacnlee/autocorrect-action@v2
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          entrypoint: './lint_and_report.sh'
          args: ''