# ==============================================================================
#  Workflow: Smart Automatic i18n Translation (v4 - Production Ready)
#
#  Features:
#  - Uses a dedicated GitHub App for secure, isolated authentication.
#  - Prevents recursive workflow runs by checking the event sender.
#  - Employs a "three-dot diff" to precisely identify PR-specific changes.
# ==============================================================================

name: Smart Automatic i18n Translation

on:
  push:
    branches:
      - main
    paths:
      - 'crater-website/content/docs/**'
      - 'crater-website/messages/**'
      - 'crater-website/src/i18n/config.ts'
      - '.github/workflows/auto-translate.yml'

jobs:
  auto-translate:
    # é¡¶çº§ if æ¡ä»¶åªåšåŸºæœ¬çš„é˜²å¾ªç¯
    if: >-
      !startsWith(github.event.head_commit.message, 'chore(i18n):') &&
      !contains(github.event.head_commit.message, 'from feature/auto-translate-')

    runs-on: self-hosted
    steps:
      - name: ğŸ” Generate a token
        id: generate-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}
      
      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      # æ–°å¢æ­¥éª¤: æ£€æŸ¥æº PR æ˜¯å¦æœ‰ 'no-translation' æ ‡ç­¾
      - name: ğŸš¦ Check for Ignore Label on Source PR
        id: check-ignore-label
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          echo "Checking commit message for PR reference..."
          # ä» 'Merge pull request #123 from ...' ä¸­æå– PR å·
          PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | sed -n 's/Merge pull request #\([0-9]\+\).*/\1/p')
          
          if [[ -z "$PR_NUMBER" ]]; then
            echo "Commit is not a merge commit, or PR number could not be extracted. Proceeding."
            echo "should_ignore=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found associated PR #$PR_NUMBER. Checking its labels..."
          PR_LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels.[].name')
          
          echo "PR labels: $PR_LABELS"
          
          if echo "$PR_LABELS" | grep -q -w "no-translation"; then
            echo "PR #$PR_NUMBER has the 'no-translation' label. Stopping workflow."
            echo "should_ignore=true" >> $GITHUB_OUTPUT
          else
            echo "No ignore label found. Proceeding."
            echo "should_ignore=false" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤ 4: æ™ºèƒ½è¿‡æ»¤æ–‡ä»¶ (å·²å¤§å¹…å¢å¼º)
      - name: âš™ï¸ Filter Files by Path, Commit History, and PR Labels
        id: files-to-process
        if: steps.check-ignore-label.outputs.should_ignore == 'false'
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          BASE_REF="${{ github.event.before }}"
          HEAD_REF="${{ github.event.after }}"
          
          # å®šä¹‰éœ€è¦ç¿»è¯‘çš„è·¯å¾„æ¨¡å¼
          TRANSLATION_PATHS_PATTERN="^crater-website/(content/docs/|messages/)"

          # 1. è·å–æ‰€æœ‰æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶ (ä½¿ç”¨ -w å¿½ç•¥ç©ºæ ¼)
          ALL_CHANGED_FILES=$(git diff -w --name-only --diff-filter=AM --no-renames $BASE_REF...$HEAD_REF)

          # 2. ä»…ä¿ç•™åœ¨æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶
          FILTERED_FILES=$(echo "$ALL_CHANGED_FILES" | grep -E "$TRANSLATION_PATHS_PATTERN" || true)

          if [[ -z "$FILTERED_FILES" ]]; then
              echo "No files in translation paths were changed. Stopping."
              echo "has_files=false" >> $GITHUB_OUTPUT
              exit 0
          fi

          echo "Files within translation paths to consider:"
          echo "${FILTERED_FILES}"

          # å°†è¿‡æ»¤åçš„æ–‡ä»¶å†æ¬¡åˆ†ä¸º Added å’Œ Modified
          ADDED_FILES=$(echo "$FILTERED_FILES" | xargs -n1 git diff -w --name-only --diff-filter=A --no-renames $BASE_REF...$HEAD_REF --)
          MODIFIED_FILES=$(echo "$FILTERED_FILES" | xargs -n1 git diff -w --name-only --diff-filter=M --no-renames $BASE_REF...$HEAD_REF --)
          
          FINAL_FILES_TO_PROCESS="$ADDED_FILES"
          echo "Found added files (will always be translated):"
          echo "${ADDED_FILES:-"None"}"

          echo "Found modified files (checking PR labels):"
          echo "${MODIFIED_FILES:-"None"}"
          
          # 3. éå†å·²ä¿®æ”¹çš„æ–‡ä»¶ï¼Œæ£€æŸ¥å…¶æ¥æº PR
          for file in $MODIFIED_FILES; do
            COMMIT_HASH=$(git log -1 -w --pretty=format:%H -- $file)
            echo "  - File '$file' was last modified by commit $COMMIT_HASH"
            PR_INFO=$(gh pr list --state merged --search "$COMMIT_HASH" --json number,labels -L 1)
            
            if [[ -z "$PR_INFO" || "$PR_INFO" == "[]" ]]; then
              echo "    - Could not find an associated merged PR. Assuming direct push. Translating."
              FINAL_FILES_TO_PROCESS=$(echo -e "$FINAL_FILES_TO_PROCESS\n$file")
              continue
            fi
            
            PR_NUMBER=$(echo "$PR_INFO" | jq -r '.[0].number')
            echo "    - Associated with PR #$PR_NUMBER"
            HAS_LABEL=$(echo "$PR_INFO" | jq '.[0].labels | map(.name) | contains(["run-translation"])')
            
            if [[ "$HAS_LABEL" == "true" ]]; then
              echo "    - PR #$PR_NUMBER has the 'run-translation' label. Adding file to process list."
              FINAL_FILES_TO_PROCESS=$(echo -e "$FINAL_FILES_TO_PROCESS\n$file")
            else
              echo "    - PR #$PR_NUMBER does NOT have the 'run-translation' label. Skipping."
            fi
          done

          # 4. æ¸…ç†å¹¶è¾“å‡ºæœ€ç»ˆæ–‡ä»¶åˆ—è¡¨
          FINAL_FILES_TO_PROCESS=$(echo "$FINAL_FILES_TO_PROCESS" | sed '/^$/d' | sort -u)

          if [[ -z "$FINAL_FILES_TO_PROCESS" ]]; then
            echo "No files to process after all filters. Workflow will stop."
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_files=true" >> $GITHUB_OUTPUT
          echo "Final list of files to process:"
          echo "$FINAL_FILES_TO_PROCESS"
          
          # Diff ç”Ÿæˆé€»è¾‘
          mkdir -p .diff_cache
          for file in $FINAL_FILES_TO_PROCESS; do
            if echo "$MODIFIED_FILES" | grep -q -w "$file"; then
              diff_filename=$(echo "$file" | tr '/' '_')
              git diff -w --no-prefix $BASE_REF...$HEAD_REF -- "$file" > ".diff_cache/${diff_filename}.diff"
              echo "  - Created diff for modified file: $file"
            fi
          done

          FILES_TO_PROCESS_ARG=$(echo "$FINAL_FILES_TO_PROCESS" | tr '\n' ',' | sed 's/,$//')
          echo "files=${FILES_TO_PROCESS_ARG}" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 5: è¿è¡Œå¼•å¯¼è„šæœ¬
      - name: ğŸš€ Run Translation Bootstrap Script
        if: steps.files-to-process.outputs.has_files == 'true'
        env:
          # å°†ä»“åº“æ ¹ç›®å½•çš„ç»å¯¹è·¯å¾„ä¼ é€’ç»™ Python
          REPO_ROOT: ${{ github.workspace }}
        run: |
          python crater-website/hack/i18n/bootstrap.py --changed-files "${{ steps.files-to-process.outputs.files }}"

      # æ­¥éª¤ 6: åˆ›å»º PR (å¢åŠ  if æ¡ä»¶)
      - name: ğŸ”’ [Setup] Isolate Git configuration
        id: setup-git
        if: steps.files-to-process.outputs.has_files == 'true'
        run: |
          echo "Saving current git credential helper..."
          # ä¿å­˜å½“å‰çš„å‡­æ®ç®¡ç†å™¨è®¾ç½®ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä¿å­˜ "none" å­—ç¬¦ä¸²
          CURRENT_HELPER=$(git config --global --get credential.helper || echo "none")
          echo "saved_helper=$CURRENT_HELPER" >> $GITHUB_OUTPUT
          
          echo "Temporarily disabling credential helper for this job..."
          # å…ˆç§»é™¤ï¼Œå†è®¾ç½®ä¸ºç©ºï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰æƒ…å†µ
          git config --global --unset credential.helper || true
          git config --global credential.helper ""

      # æ­¥éª¤ 6: ä½¿ç”¨ App èº«ä»½åˆ›å»ºåŒ…å«ç¿»è¯‘ç»“æœçš„ Pull Request (Execute)
      - name: ğŸ¤– Create Pull Request with Translations
        # å¢åŠ ä¸€ä¸ª idï¼Œä»¥ä¾¿æ¸…ç†æ­¥éª¤å¯ä»¥å¼•ç”¨å®ƒ
        id: create-pr
        if: steps.files-to-process.outputs.has_files == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ steps.generate-token.outputs.token }}
          # ... (ä½ çš„æ‰€æœ‰å…¶ä»–å‚æ•°éƒ½æ”¾åœ¨è¿™é‡Œï¼Œä¿æŒä¸å˜)
          commit-message: "chore(i18n): è‡ªåŠ¨åŒæ­¥å¤šè¯­è¨€ç¿»è¯‘"
          title: "ğŸŒ [Auto-Translate] åŒæ­¥å¤šè¯­è¨€æ–‡ä»¶"
          body: |
            ç”± **${{ secrets.APP_NAME }}** æœºå™¨äººæ ¹æ®æœ€æ–°å˜æ›´è‡ªåŠ¨åŒæ­¥ç¿»è¯‘ã€‚
            
            **è§¦å‘äº‹ä»¶:** `${{ github.event_name }}`
            
            *æ­¤ PR åªåŒ…å«æœ¬æ¬¡äº‹ä»¶ä¸­ç‹¬æœ‰çš„å˜æ›´ï¼Œå·²æ™ºèƒ½æ’é™¤åˆå¹¶ä¸»å¹²æ‰€å¼•å…¥çš„ commitsã€‚*
          branch: "feature/auto-translate-${{ github.run_id }}"
          delete-branch: true
          labels: "i18n, automated"
          author: ${{ secrets.APP_NAME }}[bot] <${{ secrets.APP_ID }}+${{ secrets.APP_NAME }}[bot]@users.noreply.github.com>
          committer: ${{ secrets.APP_NAME }}[bot] <${{ secrets.APP_ID }}+${{ secrets.APP_NAME }}[bot]@users.noreply.github.com>

      # æ­¥éª¤ 7: æ¢å¤åŸå§‹çš„ Git é…ç½® (Cleanup)
      - name: ğŸ§¹ [Cleanup] Restore original Git configuration
        # å…³é”®ï¼if: always() ç¡®ä¿æ— è®º create-pr æ­¥éª¤æ˜¯æˆåŠŸã€å¤±è´¥è¿˜æ˜¯è¢«å–æ¶ˆï¼Œè¿™ä¸ªæ¸…ç†æ­¥éª¤éƒ½ä¼šè¿è¡Œ
        if: always() && steps.setup-git.outcome == 'success'
        run: |
          echo "Restoring original git credential helper..."
          SAVED_HELPER="${{ steps.setup-git.outputs.saved_helper }}"
          # å¿…é¡»å…ˆç§»é™¤æˆ‘ä»¬è®¾ç½®çš„ç©ºå¸®åŠ©ç¨‹åº
          git config --global --unset credential.helper || true
          
          if [[ "$SAVED_HELPER" != "none" ]]; then
            echo "Restoring helper to: $SAVED_HELPER"
            git config --global credential.helper "$SAVED_HELPER"
          else
            echo "No original helper to restore."
          fi
          echo "Git configuration restored."