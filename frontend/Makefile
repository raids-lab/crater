# Makefile for Crater Frontend Development

# È¢úËâ≤ÂÆö‰πâ
RED := \033[31m
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
MAGENTA := \033[35m
CYAN := \033[36m
WHITE := \033[37m
RESET := \033[0m

# ËÆæÁΩÆÁ´ØÂè£Âè∑ÂèòÈáè
PORT := $(shell if [ -f .env.development ]; then grep PORT .env.development | cut -d '=' -f2; else echo "5180"; fi)

.PHONY: help
help: ## üí° Display this help message
	@echo "$(CYAN)üåã Crater Frontend Development Commands$(RESET)"
	@echo ""
	@echo "$(YELLOW)üìã Prerequisites:$(RESET)"
	@echo "  ‚Ä¢ Backend API server should be running on http://localhost:8088/"
	@echo "  ‚Ä¢ Storage server should be running on http://localhost:7320/"
	@echo "  ‚Ä¢ Run 'make backend-help' for backend startup instructions"
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; category = ""} \
		/^## / { category = substr($$0, 4); printf "\n$(BLUE)%s$(RESET)\n", category; next } \
		/^[a-zA-Z_-]+:.*?##/ { printf "  $(GREEN)%-15s$(RESET) %s\n", $$1, $$2 }' $(MAKEFILE_LIST)

## üõ†Ô∏è  Development Environment
.PHONY: prepare
prepare: ## üîß Prepare development environment with updated configs
	@echo "$(BLUE)Preparing development environment...$(RESET)"
	@if [ ! -f .env.development ]; then \
		echo "$(YELLOW)Creating .env.development file...$(RESET)"; \
		echo 'VITE_SERVER_PROXY_BACKEND="http://localhost:8088/"' > .env.development; \
		echo 'VITE_SERVER_PROXY_STORAGE="http://localhost:7320/"' >> .env.development; \
		echo 'VITE_USE_MSW=false  # Enable API mocking' >> .env.development; \
		echo 'VITE_TANSTACK_QUERY_DEVTOOLS=true  # Enable React Query DevTools' >> .env.development; \
		echo 'VITE_TANSTACK_ROUTER_DEVTOOLS=true  # Enable React Router DevTools' >> .env.development; \
		echo 'PORT=5180           # Dev server port' >> .env.development; \
		echo '' >> .env.development; \
		echo '# Version information (for development testing)' >> .env.development; \
		echo 'VITE_APP_VERSION="dev-local"' >> .env.development; \
		echo 'VITE_APP_COMMIT_SHA="1234567890abcdef"' >> .env.development; \
		echo 'VITE_APP_BUILD_TYPE="development"' >> .env.development; \
		echo "VITE_APP_BUILD_TIME=\"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> .env.development; \
		echo "$(GREEN)‚úÖ .env.development created successfully!$(RESET)"; \
	else \
		echo "$(GREEN)‚úÖ .env.development already exists$(RESET)"; \
	fi
	@if [ ! -d node_modules ]; then \
		echo "$(YELLOW)Installing dependencies...$(RESET)"; \
		pnpm install; \
		echo "$(GREEN)‚úÖ Dependencies installed successfully!$(RESET)"; \
	else \
		echo "$(GREEN)‚úÖ Dependencies already installed$(RESET)"; \
	fi

.PHONY: run dev
run: prepare ## üöÄ Start development server
	@echo "$(GREEN)Starting development server on port $(PORT)...$(RESET)"
	pnpm dev --port $(PORT)

dev: run ## üöÄ Alias for run command

.PHONY: deps-update
deps-update: ## üì¶ Update dependencies
	@echo "$(BLUE)Checking for outdated dependencies...$(RESET)"
	pnpm outdated
	@echo "$(YELLOW)Run 'pnpm update' to update minor versions$(RESET)"
	@echo "$(YELLOW)Run 'pnpm update --latest' to update major versions$(RESET)"

.PHONY: clean
clean: ## üßπ Clean build artifacts and dependencies
	@echo "$(RED)Cleaning build artifacts and dependencies...$(RESET)"
	rm -rf dist/
	rm -rf node_modules/
	rm -rf .turbo/
	@echo "$(GREEN)‚úÖ Cleanup completed$(RESET)"

## üèóÔ∏è  Building & Deployment
.PHONY: build
build: ## üì¶ Build for production
	@echo "$(BLUE)Building for production...$(RESET)"
	pnpm build

.PHONY: build-testing
build-testing: ## üì¶ Build for testing environment
	@echo "$(BLUE)Building for testing environment...$(RESET)"
	pnpm build-testing

.PHONY: preview
preview: ## üëÄ Preview production build
	@echo "$(BLUE)Starting preview server...$(RESET)"
	pnpm preview

## üß™ Testing & Quality Assurance
.PHONY: lint
lint: ## üîç Run ESLint and TypeScript checks
	@echo "$(YELLOW)Running TypeScript checks...$(RESET)"
	pnpm tsc --noEmit
	@echo "$(YELLOW)Running ESLint...$(RESET)"
	pnpm eslint .

.PHONY: pre-commit-check
pre-commit-check: ## Run pre-commit checks (lint and lint-staged).
	@echo "$(BLUE)Formatting translation files...$(RESET)"
	@if python3 hack/format_translation.py; then \
		echo "$(BLUE)Staging formatted translation files...$(RESET)"; \
		git add -u -- src/i18n/ 2>/dev/null || true; \
		echo "$(GREEN)‚úÖ Translation files formatted and staged$(RESET)"; \
	else \
		echo "$(RED)‚ùå Translation file formatting failed!$(RESET)"; \
		exit 1; \
	fi
	@echo "$(BLUE)Running lint checks...$(RESET)"
	@if ! pnpm run lint; then \
		echo "$(RED)‚ùå Frontend lint failed!$(RESET)"; \
		echo ""; \
		echo "$(YELLOW)üí° If you see 'command not found' or 'Cannot find module' errors:$(RESET)"; \
		echo "   Please run 'pnpm install' to install dependencies first."; \
		exit 1; \
	fi
	@echo "$(BLUE)Running lint-staged...$(RESET)"
	@if ! pnpm exec lint-staged; then \
		echo "$(RED)‚ùå Frontend lint-staged failed!$(RESET)"; \
		exit 1; \
	fi

.PHONY: lint-fix
lint-fix: ## üîß Fix ESLint issues automatically
	@echo "$(YELLOW)Running TypeScript checks...$(RESET)"
	pnpm tsc --noEmit
	@echo "$(YELLOW)Fixing ESLint issues...$(RESET)"
	pnpm eslint . --fix

.PHONY: type-check
type-check: ## üìù Run TypeScript type checking
	@echo "$(YELLOW)Running TypeScript type checking...$(RESET)"
	pnpm tsc --noEmit

.PHONY: format
format: ## ‚ú® Format code with Prettier
	@echo "$(MAGENTA)Formatting code with Prettier...$(RESET)"
	pnpm prettier --write .

.PHONY: test
test: ## üß™ Run tests
	@echo "$(CYAN)Running tests...$(RESET)"
	@echo "$(YELLOW)Note: Add test command to package.json if needed$(RESET)"

## üõ°Ô∏è  Code Generation & Backend Integration
.PHONY: generate
generate: ## üõ†Ô∏è Generate error codes from backend
	@echo "$(BLUE)Generating code...$(RESET)"
	python3 ./src/services/generator.py ../web-backend/internal/resputil/code.go ./src/services/error_code.ts

.PHONY: backend-help
backend-help: ## ‚ùì Show backend server startup instructions
	@echo "$(CYAN)üöÄ Backend Server Startup Instructions$(RESET)"
	@echo ""
	@echo "$(YELLOW)1. API Backend Server (Port 8088):$(RESET)"
	@echo "   ‚Ä¢ Navigate to your backend directory"
	@echo "   ‚Ä¢ Run: $(GREEN)make run$(RESET) or $(GREEN)go run main.go$(RESET)"
	@echo "   ‚Ä¢ Ensure it's accessible at: $(BLUE)http://localhost:8088/$(RESET)"
	@echo ""
	@echo "$(YELLOW)2. Storage Server (Port 7320):$(RESET)"
	@echo "   ‚Ä¢ Navigate to your storage service directory"
	@echo "   ‚Ä¢ Run the appropriate startup command for your storage service"
	@echo "   ‚Ä¢ Ensure it's accessible at: $(BLUE)http://localhost:7320/$(RESET)"
	@echo ""
	@echo "$(YELLOW)3. Verify Services:$(RESET)"
	@echo "   ‚Ä¢ API Backend: $(GREEN)curl http://localhost:8088/health$(RESET)"
	@echo "   ‚Ä¢ Storage Server: $(GREEN)curl http://localhost:7320/health$(RESET)"
	@echo ""
	@echo "$(CYAN)üí° Tips:$(RESET)"
	@echo "   ‚Ä¢ Check your backend documentation for specific startup commands"
	@echo "   ‚Ä¢ Ensure all required environment variables are set"
	@echo "   ‚Ä¢ Use Docker Compose if available for easier service management"

# ÈªòËÆ§ÁõÆÊ†á
.DEFAULT_GOAL := help
